sudo: required
services:
- docker
env:
  global:
  - REGISTRY_USER=kalemena
  - secure: LLSYDoelxvxbTG0G5CCS6et1kIoALz2irtleqSO30MDvkREYSJz6sVzdJzRYPKbRh7WosYtaY5MwWLgIKCJzgqv7fzXLOc4dhGdqZp3B3C6dFQfbobqfPfUgcT0SWRoNHOsu5wGMXJlwkge1uFae+t4gxo0qUwZm/prQmb8taNhwwpOM5rzIWaYa45BaCBcc6FHMVYGsYPH2ezP+iA7fmTy3Tn6neJuiObrkLKc0Dm/+hCC1Ma4tqH5EaJA21jV8ixyaA/htA+aaMSy8sV3XFTnZKvpk5WqEBte2sJHZIBbCIXzMBuPStKVpeqjycZhYjCdMJ1eg1/2w4hiGvKPfTaMW/ROk6qJgfpNKr2pvH3GiXrsn9CfbabeegdldFO6yMkZ+s+UUeHr7sVVR1qgwzDrzDr5PYB4bVBnI51IMrEs1P9IYxlfsIb/V/jkBZsZLG7myizDAA16ZIpripGl0fLO+B3MPhrYzEM0wrA4ebzvX1OX3V3RhCCJHI3VMRqibdDS0aiQsJd1WU1/SgCs1+XtYE+wuZWx/+IjVvGBmHjzjKa6bitSttS44Ko5Z10BO3bCaiHfpPSevceJZOelYGkIExUTQU9rPkBfQk1uaVA6WWaY1moc6P9bQpnILPtgb1S0sZRf91QaYIiym8z8URy1B9Fc+mKcp/3Om0YFSeJQ=
  matrix:
  - IMAGE="kalemena/tensorflow" VERSION="latest" REPO="kalemena/docker-tensorflow"
before_script:
- docker pull centos:7
- docker pull ${IMAGE}:${VERSION} || true
script:
- |
  docker build --pull --cache-from ${IMAGE}:${VERSION} \
    -t ${IMAGE}:${VERSION} \
    -f Dockerfile \
    --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
    --build-arg VCS_REF=`git rev-parse --short HEAD` \
    --build-arg VERSION=${VERSION} .
- docker ps -a
- docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
- docker images
before_deploy:
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker push ${IMAGE}:${VERSION}; docker push ${IMAGE}:latest
  on:
    branch: master
